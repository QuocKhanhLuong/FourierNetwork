# =============================================================================
# SpecMamba - Master Configuration File
# =============================================================================
# Unified config for all training scripts (train_acdc, train_mnm, train_brats, train_synapse)
# =============================================================================

# Quick preset - override individual settings below if needed
# Options: baseline, lite, sota
preset: "sota"

# =============================================================================
# MODEL CONFIGURATION
# =============================================================================
model:
  name: "HRNetDCN"               # "HRNetDCN" or "EGMNet" (legacy)
  
  # Common settings
  img_size: 224                  # Input image size
  
  # HRNet DCN Settings
  hrnet_dcn:
    base_channels: 48            # 32=small, 48=base, 64=large
    use_pointrend: true          # PointRend for boundary refinement
    full_resolution_mode: false  # Keep 224x224 (high VRAM)
    
    # Stage depths (asymmetric DCN)
    stage_configs:
      stage2: 2
      stage3: 4
      stage4: 6
      
    # Dilation Pyramid (HDC strategy)
    dilation_pyramid:
      enabled: true              # Auto: [1, 2, 4, 8, 16, 32]

# =============================================================================
# DATASET CONFIGURATION
# =============================================================================
datasets:
  # ACDC - Cardiac MRI
  acdc:
    in_channels: 3
    num_classes: 4
    class_names: ["BG", "RV", "MYO", "LV"]
    root: "preprocessed_data/ACDC"
    train_dir: "training"
    test_dir: "testing"
    
  # M&M - Cardiac MRI (Multi-vendor)
  mnm:
    in_channels: 3
    num_classes: 4
    class_names: ["BG", "LV", "MYO", "RV"]
    root: "preprocessed_data/MnM"
    train_dir: "training"
    test_dir: "testing"
    
  # BraTS21 - Brain Tumor MRI
  brats:
    in_channels: 4               # 4 modalities: T1, T1ce, T2, FLAIR
    num_classes: 4
    class_names: ["BG", "NCR", "ED", "ET"]
    root: "preprocessed_data/BraTS21"
    train_dir: "training"
    test_dir: null               # Use train/val split
    
  # Synapse - Multi-organ CT
  synapse:
    in_channels: 3
    num_classes: 14
    class_names: ["BG", "Spleen", "R.Kidney", "L.Kidney", "Gallbladder",
                  "Esophagus", "Liver", "Stomach", "Aorta", "IVC",
                  "Portal Vein", "Pancreas", "R.AG", "L.AG"]
    root: "preprocessed_data/Synapse"
    train_dir: "training"
    test_dir: "testing"

# Active dataset (override via CLI)
data:
  dataset: "acdc"
  train_split: 0.8
  seed: 42
  use_memmap: true
  max_cache: 10
  pin_memory: true

# =============================================================================
# TRAINING CONFIGURATION
# =============================================================================
training:
  # Basic
  epochs: 150
  batch_size: 8                  # Reduce for BraTS (4 channels)
  num_workers: 4
  
  # Optimizer
  optimizer: "adamw"
  learning_rate: 1e-4
  weight_decay: 1e-5
  
  # Scheduler
  scheduler: "cosine"
  scheduler_params:
    T_max: 150
    eta_min: 1e-6
    
  # Training Techniques
  grad_clip: 1.0
  use_amp: true                  # Mixed precision (recommended)
  early_stop: 30
  
  # Warmup
  warmup_epochs: 10

# =============================================================================
# LOSS CONFIGURATION
# =============================================================================
loss:
  ce_weight: 1.0
  dice_weight: 1.0
  boundary_weight: 0.5
  warmup_epochs: 10              # Boundary loss warmup

# =============================================================================
# EVALUATION CONFIGURATION
# =============================================================================
evaluation:
  mode: "3d"                     # "2d" or "3d" volumetric
  eval_interval: 5               # Evaluate every N epochs
  
  # Test Time Augmentation
  tta:
    enabled_val: false
    enabled_test: true
    modes: 8

# =============================================================================
# OUTPUT CONFIGURATION
# =============================================================================
output:
  save_dir: "weights"
  exp_name: null                 # Auto-generate if null
  save_best: true
  save_last: true

# =============================================================================
# PRESETS
# =============================================================================
# baseline:
#   model.hrnet_dcn.base_channels: 32
#   model.hrnet_dcn.use_pointrend: false
#   training.use_amp: false
#   ~10M params
#
# lite:
#   model.hrnet_dcn.base_channels: 32
#   training.batch_size: 16
#   ~10M params, fast training
#
# sota: â˜… RECOMMENDED
#   model.hrnet_dcn.base_channels: 48
#   model.hrnet_dcn.use_pointrend: true
#   loss.boundary_weight: 0.5
#   training.use_amp: true
#   ~25M params, best accuracy
# =============================================================================
